<% layout('../layouts/admin') -%>
<div class="row">
    <div class="col-md-12">
        <div class="card bg-transparent">
            <div class="contact-header d-flex align-items-sm-center media flex-column flex-sm-row bg-white mb-30">
                <div class="contact-header-left media-body d-flex align-items-center mr-4 col-6">
                    <!-- Add Concierge -->
                    <div class="page-title-box">
                        <div class="page-title-left">
                            <ol class="breadcrumb m-0">
                                <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
                                <li class="breadcrumb-item"><a href="/categories">Categories</a></li>
                                <li class="breadcrumb-item active"><a href="javascript: void(0);">Add</a></li>
                            </ol>
                        </div>
                    </div>
                    <!-- End Add Concierge -->
                </div>
            </div>
         </div>
    </div>
</div>
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h4 class="page-title mb-30">Add Category</h4>
                    <form method="post" id="addCategoryForm">
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="form-group mb-3">
                                    <label>Add Category<span class="text-danger">*</span></label>
                                    <input type="text" id="main_category" name="name" class="form-control" placeholder="Add Category" autocomplete="off">
                                    <div class="text-danger name"></div>
                                </div>

                                <label>Add Sub-Catgeory<span class="text-danger"></span></label>
                                <div class="row">
                                    <div class="col-lg-6 mb-3 subcategory addCatMain">
                                        
                                    </div>
                                    
                                    <div class="col-lg-12">
                                        <a id="add-sub-category" class="btn btn-primary waves-effect waves-light" style="color: #ffffff;"><i class="fa fa-plus"></i> Add New Sub-Catgeory</a>
                                    </div>
                                    
                                </div>
                            </div>

                            <div class="col-lg-12 text-left">
                                <div class="form-group mb-3 text-center">
                                    <button id="submitAddCategoryForm" type="submit" class="btn btn-primary waves-effect waves-light">Submit</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>

        $(document).ready(function () {
            
            $('#main_category').blur(function() {
                var main_category = $(this).val();  
                if(main_category != ''){
                    $.ajax({
                        url: '<%= siteUrl %>/categories/validate-category',
                        type: "POST",             
                        data: {
                            'category': main_category
                        },
                        dataType: "json",
                            
                        success: function(data) {
                            if(data.data > 0){
                                $('.name').html('<label id="name-error" class="error" for="name">Category Already Exist!</label>');
                                return false
                            }else{
                                $('.name').html('');
                            }
                        }
                    });
                }
            });


            var sub_category_count = 0;

            $('#add-sub-category').on('click',function(){
                sub_category_count++;
                $('.subcategory').append(`<div style="min-height: 32px;" class="form-group mb-3 sub-`+sub_category_count+`">
                                            <input type="text" name='subname[`+sub_category_count+`]' class="form-control" placeholder="Add Sub-Catgeory" autocomplete="off" style="width: 95%; float: left;">
                                            <a href="javascript:void(0);" class="removesub" attrrem="`+sub_category_count+`" style="float: right;">X</a>
                                            <div class="text-danger name"></div>
                                        </div>`);
                
            });

            $(document).on('click','.removesub',function(){
                var attrrem = $(this).attr('attrrem');
                $('.sub-'+attrrem).remove();
                sub_category_count--;
            });

                const ADD_CATEGORIES_FORM = <%- JSON.stringify(DM('ADD_CATEGORIES_FORM')) %>;
                $("#addCategoryForm").validate({
                    errorPlacement: function (error, element) {
                        const name = $(element).attr("name");
                        error.appendTo($("." + name));
                    },
                    submitHandler: function (form) {
                        var main_category = $('#main_category').val();  
                        $.ajax({
                            url: '<%= siteUrl %>/categories/validate-category',
                            type: "POST",             
                            data: {
                                'category': main_category
                            },
                            dataType: "json",
                                
                            success: function(data) {
                                if(data.data > 0){
                                    $('.name').html('<label id="name-error" class="error" for="name">Category Already Exist!</label>');
                                    return false
                                }else{
                                    $('#submitAddCategoryForm').attr('disabled', 'disabled');
                                    form.submit();
                                }
                            }
                        });
                        
                    },
                    rules: {
                        name: {
                            required: true,
                            minlength: 3,
                            maxlength: 30,
                            pattern: /^[a-zA-Z0-9 ]*$/
                        }
                    },
                    messages: ADD_CATEGORIES_FORM
                });
            });
    </script>